(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{142:function(e,r,t){e.exports=t.p+"assets/img/browserarch.33f0ae57.png"},143:function(e,r,t){e.exports=t.p+"assets/img/processcontrol.ec3756ad.png"},144:function(e,r,t){e.exports=t.p+"assets/img/rendererprocess.63ff67bd.png"},166:function(e,r,t){"use strict";t.r(r);var a=t(0),s=Object(a.a)({},(function(){var e=this,r=e.$createElement,a=e._self._c||r;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"浏览器是怎么工作的"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#浏览器是怎么工作的","aria-hidden":"true"}},[e._v("#")]),e._v(" 浏览器是怎么工作的")]),e._v(" "),a("h2",{attrs:{id:"浏览器架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#浏览器架构","aria-hidden":"true"}},[e._v("#")]),e._v(" 浏览器架构")]),e._v(" "),a("p",[e._v("浏览器架构实现没有标准规范， 可以是拥有许多不同线程的单进程， 也可以是多进程，每个进程拥有几个线程，进程间通过 IPC 通信。")]),e._v(" "),a("p",[e._v("下面以 Chrome 为例, 顶部的 Browser 进程协调负责应用不同部分的其他进程， 对于 Renderer 进程， 浏览器的每个 tab 分配一个进程（资源允许的话； 现在页面内有 iframe 的话，也可以给每个站点分配一个进程。）")]),e._v(" "),a("p",[a("img",{attrs:{src:t(142),alt:"browser architecture"}})]),e._v(" "),a("p",[a("img",{attrs:{src:t(143),alt:"process controls what"}})]),e._v(" "),a("h3",{attrs:{id:"多进程架构特点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#多进程架构特点","aria-hidden":"true"}},[e._v("#")]),e._v(" 多进程架构特点")]),e._v(" "),a("ul",[a("li",[e._v("一个 tab 无响应的话， 不影响其他 tab 功能")]),e._v(" "),a("li",[e._v("安全性和沙盒（sandboxing）\n"),a("ul",[a("li",[e._v("操作系统提供了限制进程特性的功能，浏览器可以应用来限制部分特性， 比如 renderer process 的文件访问权限。")])])]),e._v(" "),a("li",[e._v("缺点： 内存占用更高\n"),a("ul",[a("li",[e._v("解决方法： 服务化（详见参考文章 part 1）")])])])]),e._v(" "),a("h2",{attrs:{id:"导航"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#导航","aria-hidden":"true"}},[e._v("#")]),e._v(" 导航")]),e._v(" "),a("p",[e._v("Browser Process 内")]),e._v(" "),a("ul",[a("li",[e._v("UI thread  负责导航栏按钮和输入框")]),e._v(" "),a("li",[e._v("Network thread  负责网络请求")]),e._v(" "),a("li",[e._v("Storage thread  文件相关操作")])]),e._v(" "),a("h3",{attrs:{id:"navigation-步骤"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#navigation-步骤","aria-hidden":"true"}},[e._v("#")]),e._v(" navigation 步骤")]),e._v(" "),a("ol",[a("li",[e._v("Handling input")])]),e._v(" "),a("ul",[a("li",[e._v("UI thread 判断地址栏输入是搜索查询数据还是 URL")])]),e._v(" "),a("ol",{attrs:{start:"2"}},[a("li",[e._v("Start navigation")])]),e._v(" "),a("ul",[a("li",[e._v("UI thread 发起一个获取站点内容的 network call，tab 上 loading spinner 显示， 然后 Network thread 为请求建立连接")]),e._v(" "),a("li",[e._v("Network thread 收到重定向的响应的话，就会通知 UI thread 服务请求重定向， 然后另一个 URL request 被发起")])]),e._v(" "),a("ol",{attrs:{start:"3"}},[a("li",[e._v("Read response")])]),e._v(" "),a("ul",[a("li",[e._v("Network thread 收到响应后读取 content-type header 判断数据类型")]),e._v(" "),a("li",[e._v("如果是 html 的话进入下一步， 是 zip 或其他文件的话就将数据传给 download manager")]),e._v(" "),a("li",[e._v("安全检查也发生在这一步，是恶意站点的话显示 warning page")])]),e._v(" "),a("ol",{attrs:{start:"4"}},[a("li",[e._v("Find a renderer process")])]),e._v(" "),a("ul",[a("li",[e._v("Network thread 通知 UI thread 数据准备好了， UI thread 查找一个 renderer process 去渲染网页")]),e._v(" "),a("li",[e._v("因为网络请求可能耗时几百毫秒，可以做一个加快进程的优化，在第二步发起网路请求的时候 UI thread 就可以查找或开启一个 renderer process")])]),e._v(" "),a("ol",{attrs:{start:"5"}},[a("li",[e._v("Commit navigation")])]),e._v(" "),a("ul",[a("li",[e._v("数据和 renderer process 都准备好后， browser process 向 renderer process 发送一个 IPC 来提交跳转，同时把数据传过去。 browser process 收到 renderer process 确认后，导航至此结束，然后文档加载开始。")])]),e._v(" "),a("ol",{attrs:{start:"6"}},[a("li",[e._v("额外步骤")])]),e._v(" "),a("ul",[a("li",[e._v('renderer process "finishes" rendering 后，向 browser process 发回一个 IPC（ this is after all the onload events have fired on all frames in the page and have finished executing ），UI thread 结束 tab 上的 loading spinner。')])]),e._v(" "),a("h4",{attrs:{id:"跳转到不同站点的情况"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#跳转到不同站点的情况","aria-hidden":"true"}},[e._v("#")]),e._v(" 跳转到不同站点的情况")]),e._v(" "),a("ul",[a("li",[e._v("需要 check beforeunload 事件")]),e._v(" "),a("li",[e._v("start new renderer process, unload old renderer process")])]),e._v(" "),a("h2",{attrs:{id:"renderer-process-内部工作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#renderer-process-内部工作","aria-hidden":"true"}},[e._v("#")]),e._v(" Renderer process 内部工作")]),e._v(" "),a("p",[e._v("renderer process 负责一个 tab 内的所有事情")]),e._v(" "),a("ul",[a("li",[e._v("其中 main thread 处理绝大部分的代码")]),e._v(" "),a("li",[e._v("使用 web worker 或 service worker 的话，部分代码由 worker threads 处理")]),e._v(" "),a("li",[e._v("compositor and raster threads 帮助高效平滑的渲染页面")])]),e._v(" "),a("p",[a("img",{attrs:{src:t(144),alt:"renderer process"}})]),e._v(" "),a("h3",{attrs:{id:"parsing"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#parsing","aria-hidden":"true"}},[e._v("#")]),e._v(" Parsing")]),e._v(" "),a("ul",[a("li",[e._v("main thread 解析 html, 构建 DOM")]),e._v(" "),a("li",[e._v("subresource loading\n"),a("ul",[a("li",[e._v("额外资源在解析过程中按顺序请求")]),e._v(" "),a("li",[e._v("preload scanner\n"),a("ul",[a("li",[e._v('解析 html 的同时， "preload scanner" 并行处理， 遇到 '),a("code",[e._v("<img>")]),e._v(" 或 "),a("code",[e._v("<link>")]),e._v(" 时， 向 browser process 内的 network thread 发出请求")])])])])]),e._v(" "),a("li",[e._v("JS 会阻塞 parsing\n"),a("ul",[a("li",[e._v("因为 JS 会使用像 document.write() 来改变 DOM 结构")])])])]),e._v(" "),a("h4",{attrs:{id:"提示资源加载方式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#提示资源加载方式","aria-hidden":"true"}},[e._v("#")]),e._v(" 提示资源加载方式")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("<script>")]),e._v(" 上 defer, async")]),e._v(" "),a("li",[a("code",[e._v("<link>")]),e._v(" 上 preload, prefetch")])]),e._v(" "),a("h3",{attrs:{id:"style-calculation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#style-calculation","aria-hidden":"true"}},[e._v("#")]),e._v(" Style calculation")]),e._v(" "),a("ul",[a("li",[e._v("main thread 解析 CSS 确定每一个 DOM node 的 computed style")])]),e._v(" "),a("h3",{attrs:{id:"layout"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#layout","aria-hidden":"true"}},[e._v("#")]),e._v(" Layout")]),e._v(" "),a("ul",[a("li",[e._v("main thread 遍历 DOM 和 computed style，创建 layout tree")]),e._v(" "),a("li",[e._v("layout tree 拥有每一个节点的几何信息， x、y坐标，边界盒尺寸等")]),e._v(" "),a("li",[e._v("layout tree 和 DOM tree 相似但并不一样，display:none 的元素不在，添加了伪元素")])]),e._v(" "),a("h3",{attrs:{id:"paint"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#paint","aria-hidden":"true"}},[e._v("#")]),e._v(" Paint")]),e._v(" "),a("ul",[a("li",[e._v("main thread 遍历 layout tree 创建 "),a("strong",[e._v("paint records")])]),e._v(" "),a("li",[e._v('Paint record is a note of painting process like "background first, then text, then rectangle"')])]),e._v(" "),a("h3",{attrs:{id:"compositing"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#compositing","aria-hidden":"true"}},[e._v("#")]),e._v(" Compositing")]),e._v(" "),a("h4",{attrs:{id:"概念"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#概念","aria-hidden":"true"}},[e._v("#")]),e._v(" 概念")]),e._v(" "),a("ul",[a("li",[e._v("rasterizing: Turning the structure of the document, the style of each element, the geometry of the page, and the paint order information into pixels on the screen")]),e._v(" "),a("li",[e._v("Compositing: separate parts of a page into layers, rasterize them separately, and composite as a page in a separate thread called compositor thread")])]),e._v(" "),a("h4",{attrs:{id:"步骤"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#步骤","aria-hidden":"true"}},[e._v("#")]),e._v(" 步骤")]),e._v(" "),a("ul",[a("li",[e._v("main thread walks through the layout tree to create the "),a("strong",[e._v("layer tree")]),e._v(".")]),e._v(" "),a("li",[e._v("the main thread commits that information to the compositor thread. The compositor thread then rasterizes each layer, create "),a("strong",[e._v("compositor frame")]),e._v(".\n"),a("ul",[a("li",[e._v("A layer could be large like the entire length of a page, so the compositor thread divides them into tiles and sends each tile off to raster threads. Raster threads rasterize each tile and store them in GPU memory.")]),e._v(" "),a("li",[e._v("Once tiles are rastered, compositor thread gathers tile information called draw quads to create a compositor frame.")])])]),e._v(" "),a("li",[e._v("A compositor frame is then submitted to the browser process via IPC. At this point, another compositor frame could be added from UI thread for the browser UI change or from other renderer processes for extensions. "),a("strong",[e._v("These compositor frames are sent to the GPU to display it on a screen.")]),e._v(" If a scroll event comes in, compositor thread creates another compositor frame to be sent to the GPU.")])]),e._v(" "),a("h2",{attrs:{id:"参考文章"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考文章","aria-hidden":"true"}},[e._v("#")]),e._v(" 参考文章")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://developers.google.com/web/updates/2018/09/inside-browser-part1",target:"_blank",rel:"noopener noreferrer"}},[e._v("Inside look at modern web browser (part 1)"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://developers.google.com/web/updates/2018/09/inside-browser-part2",target:"_blank",rel:"noopener noreferrer"}},[e._v("Inside look at modern web browser (part 2)"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://developers.google.com/web/updates/2018/09/inside-browser-part3",target:"_blank",rel:"noopener noreferrer"}},[e._v("Inside look at modern web browser (part 3)"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://developers.google.com/web/updates/2018/09/inside-browser-part4",target:"_blank",rel:"noopener noreferrer"}},[e._v("Inside look at modern web browser (part 4)"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);r.default=s.exports}}]);